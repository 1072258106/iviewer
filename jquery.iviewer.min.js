/*
 * iviewer Plugin for jQuery JavaScript Library
 * https://github.com/can3p/iviewer
 *
 * Copyright (c) 2009 - 2011 Dmitry Petrov
 * Dual licensed under the MIT and GPL licenses.
 *  - http://www.opensource.org/licenses/mit-license.php
 *  - http://www.gnu.org/copyleft/gpl.html
 *
 * Author: Dmitry Petrov
 * Version: dev
 * Date:
 */
(function(c){c.widget("ui.iviewer",c.ui.mouse,{widgetEventPrefix:"iviewer",options:{zoom:"fit",zoom_base:100,zoom_max:800,zoom_min:25,zoom_delta:1.4,ui_disabled:!1,update_on_resize:!0,onZoom:null,onStartDrag:null,onDrag:null,onMouseMove:null,onClick:null,onStartLoad:null,onFinishLoad:null},_create:function(){var a=this;this.dy=this.dx=0;this.dragged=!1;this.img_object={};this.zoom_object={};this.image_loaded=!1;this.current_zoom=this.options.zoom;if(this.options.src!==null)this.container=this.element,
this._updateContainerInfo(),this.container.css("overflow","hidden"),this.options.update_on_resize==!0&&c(window).resize(function(){a._updateContainerInfo()}),this.img_object.x=0,this.img_object.y=0,this.img_object.object=c("<img>").css({position:"absolute",top:"0px",left:"0px"}).click(function(b){return a.click(b)}).mousewheel(function(b,c){a.zoom_by(c>0?1:-1);return!1}),this.img_object.object.prependTo(a.container),this.loadImage(this.options.src),this.options.ui_disabled||this.createui(),this._mouseInit()},
destroy:function(){this._mouseDestroy()},_updateContainerInfo:function(){this.options.height=this.container.height();this.options.width=this.container.width()},loadImage:function(a){this.current_zoom=this.options.zoom;this.image_loaded=!1;var b=this;this.options.onStartLoad&&this.options.onStartLoad.call(this);this.img_object.object.unbind("load").removeAttr("src").removeAttr("width").removeAttr("height").css({top:0,left:0,width:"",height:""}).load(function(){b.image_loaded=!0;b.img_object.display_width=
b.img_object.orig_width=this.width;b.img_object.display_height=b.img_object.orig_height=this.height;b.container.hasClass("iviewer_cursor")||b.container.addClass("iviewer_cursor");b.options.zoom=="fit"?b.fit():b.set_zoom(b.options.zoom);b.options.onFinishLoad&&b.options.onFinishLoad.call(b)}).attr("src",a)},fit:function(){var a=0,a=this.img_object.orig_width/this.img_object.orig_height>this.options.width/this.options.height?this.options.width/this.img_object.orig_width*100:this.options.height/this.img_object.orig_height*
100;this.set_zoom(a)},center:function(){this.setCoords(-Math.round((this.img_object.display_height-this.options.height)/2),-Math.round((this.img_object.display_width-this.options.width)/2))},moveTo:function(a,b){var c=a-Math.round(this.options.width/2),d=b-Math.round(this.options.height/2);this.setCoords(this.img_object.x-c,this.img_object.y-d)},getContainerOffset:function(){return jQuery.extend({},this.container.offset())},setCoords:function(a,b){this.image_loaded&&(c.extend(this.img_object,this._correctCoords(a,
b)),this.img_object.object.css("top",this.img_object.y+"px").css("left",this.img_object.x+"px"))},_correctCoords:function(a,b){a=parseInt(a,10);b=parseInt(b,10);b>0&&(b=0);a>0&&(a=0);b+this.img_object.display_height<this.options.height&&(b=this.options.height-this.img_object.display_height);a+this.img_object.display_width<this.options.width&&(a=this.options.width-this.img_object.display_width);this.img_object.display_width<=this.options.width&&(a=-(this.img_object.display_width-this.options.width)/
2);this.img_object.display_height<=this.options.height&&(b=-(this.img_object.display_height-this.options.height)/2);return{x:a,y:b}},containerToImage:function(a,b){return a<this.img_object.x||b<this.img_object.y||a>this.img_object.x+this.img_object.display_width||b>this.img_object.y+this.img_object.display_height?!1:{x:d.descaleValue(a-this.img_object.x,this.current_zoom),y:d.descaleValue(b-this.img_object.y,this.current_zoom)}},imageToContainer:function(a,b){return a>this.img_object.orig_width||
b>this.img_object.orig_height?!1:{x:this.img_object.x+d.scaleValue(a,this.current_zoom),y:this.img_object.y+d.scaleValue(b,this.current_zoom)}},getMouseCoords:function(a){var b=this.img_object.object.offset();return{x:d.descaleValue(a.pageX-b.left,this.current_zoom),y:d.descaleValue(a.pageY-b.top,this.current_zoom)}},set_zoom:function(a){if(!(this.options.onZoom&&this.options.onZoom.call(this,a)==!1)&&this.image_loaded){if(a<this.options.zoom_min)a=this.options.zoom_min;else if(a>this.options.zoom_max)a=
this.options.zoom_max;if(this.current_zoom=="fit"){var b=Math.round(this.options.width/2+this.img_object.orig_width/2),e=Math.round(this.options.height/2+this.img_object.orig_height/2);this.current_zoom=100}else b=-parseInt(this.img_object.object.css("left"),10)+Math.round(this.options.width/2),e=-parseInt(this.img_object.object.css("top"),10)+Math.round(this.options.height/2);var h=d.scaleValue(this.img_object.orig_width,a),f=d.scaleValue(this.img_object.orig_height,a),b=d.scaleValue(d.descaleValue(b,
this.current_zoom),a),e=d.scaleValue(d.descaleValue(e,this.current_zoom),a),b=this.options.width/2-b,e=this.options.height/2-e;this.img_object.display_width=h;this.img_object.display_height=f;c.extend(this.img_object,this._correctCoords(b,e));this.img_object.object.animate({width:h,height:f,top:this.img_object.y,left:this.img_object.x},200);this.current_zoom=a;c.isFunction(this.options.onAfterZoom)&&this.options.onAfterZoom.call(this,a);this.update_status()}},zoom_by:function(a){var b=this.find_closest_zoom_rate(this.current_zoom)+
a,b=this.options.zoom_base*Math.pow(this.options.zoom_delta,b);a>0&&b<this.current_zoom&&(b*=this.options.zoom_delta);a<0&&b>this.current_zoom&&(b/=this.options.zoom_delta);this.set_zoom(b)},find_closest_zoom_rate:function(a){function b(a,b){return a/b}function c(a,b){return a*b}if(a==this.options.zoom_base)return 0;for(var d=a>this.options.zoom_base?c:b,f=a>this.options.zoom_base?1:-1,i=this.options.zoom_delta,g=1;Math.abs(d(this.options.zoom_base,Math.pow(i,g))-a)>Math.abs(d(this.options.zoom_base,
Math.pow(i,g+1))-a);)g++;return f*g},update_status:function(){if(!this.options.ui_disabled){var a=Math.round(100*this.img_object.display_height/this.img_object.orig_height);a&&this.zoom_object.html(a+"%")}},_mouseStart:function(a){if(this.options.onStartDrag&&this.options.onStartDrag.call(this,this.getMouseCoords(a))==!1)return!1;this.dragged=!0;this.container.addClass("iviewer_drag_cursor");this.dx=a.pageX-this.img_object.x;this.dy=a.pageY-this.img_object.y;return!0},_mouseCapture:function(){return!0},
_mouseDrag:function(a){this.options.onMouseMove&&this.options.onMouseMove.call(this,this.getMouseCoords(a));if(this.dragged)return this.options.onDrag&&this.options.onDrag.call(this,this.getMouseCoords(a)),this.setCoords(a.pageX-this.dx,a.pageY-this.dy),!1},_mouseStop:function(){this.container.removeClass("iviewer_drag_cursor");this.dragged=!1},click:function(a){this.options.onClick&&this.options.onClick.call(this,this.getMouseCoords(a))},createui:function(){var a=this;c("<div>").addClass("iviewer_zoom_in").addClass("iviewer_common").addClass("iviewer_button").mousedown(function(){a.zoom_by(1);
return!1}).appendTo(this.container);c("<div>").addClass("iviewer_zoom_out").addClass("iviewer_common").addClass("iviewer_button").mousedown(function(){a.zoom_by(-1);return!1}).appendTo(this.container);c("<div>").addClass("iviewer_zoom_zero").addClass("iviewer_common").addClass("iviewer_button").mousedown(function(){a.set_zoom(100);return!1}).appendTo(this.container);c("<div>").addClass("iviewer_zoom_fit").addClass("iviewer_common").addClass("iviewer_button").mousedown(function(){a.fit(this);return!1}).appendTo(this.container);
this.zoom_object=c("<div>").addClass("iviewer_zoom_status").addClass("iviewer_common").appendTo(this.container);this.update_status()}});var d={scaleValue:function(a,b){return a*b/100},descaleValue:function(a,b){return a*100/b}}})(jQuery,void 0);
